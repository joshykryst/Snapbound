<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Photos - SnapBound</title>
    <link rel="stylesheet" href="picture.css">
</head>
<body>
    <div class="select-photos-container">
        <h2>Choose Your Strip Style</h2>
        <div class="strip-options">
            <div class="strip-preview" data-color="Red">
                <img src="Photo/Red.png" alt="Red Strip">
            </div>
            <div class="strip-preview" data-color="Blue">
                <img src="Photo/Blue.png" alt="Blue Strip">
            </div>
            <div class="strip-preview" data-color="Green">
                <img src="Photo/Green.png" alt="Green Strip">
            </div>
            <div class="strip-preview" data-color="Yellow">
                <img src="Photo/Yellow.png" alt="Yellow Strip">
            </div>
            <div class="strip-preview" data-color="Purple">
                <img src="Photo/Purple.png" alt="Purple Strip">
            </div>
            <div class="strip-preview" data-color="Copper">
                <img src="Photo/Copper.png" alt="Copper Strip">
            </div>
            <div class="strip-preview" data-color="White">
                <img src="Photo/White.png" alt="White Strip">
            </div>
        </div>

        <h2>Choose Photo Effect</h2>
        <div class="effect-options">
            <button class="effect-btn active">Normal</button>
            <button class="effect-btn">Black & White</button>
            <button class="effect-btn">Sepia</button>
            <button class="effect-btn">Vintage</button>
            <button class="effect-btn">High Contrast</button>
        </div>

        <div class="photos-grid" id="photosGrid">
            <!-- Photos will be loaded here -->
        </div>

        <div class="selection-controls">
            <button id="downloadPhotos">Download Photos</button>
            <button id="downloadStrip">Download PhotoStrip</button>
        </div>
    </div>

    <style>
        .strip-options {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 20px 0;
            margin-bottom: 30px;
            justify-content: center;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .photo-container {
            position: relative;
            aspect-ratio: 3/4;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .photo-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .selection-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .selection-controls button {
            padding: 12px 24px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .strip-preview {
            flex: 0 0 auto;
            width: 120px;
            height: 300px;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        .strip-preview.active {
            border-color: #ff4757;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.3);
            transform: scale(1.05);
        }

        .strip-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .effect-options {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .effect-btn {
            padding: 8px 16px;
            border: 2px solid #ff4757;
            background: transparent;
            color: #ff4757;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .effect-btn.active {
            background: #ff4757;
            color: white;
        }

        .photo-container {
            position: relative;
            display: inline-block;
            margin: 10px;
        }

        .photo-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            transform: scale(1.5);
            cursor: pointer;
        }
    </style>

    <script>
        // Add this function at the start of your script
        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => {
                    console.error(`Failed to load image: ${url}`);
                    resolve(false);
                };
                img.src = url;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const photosGrid = document.getElementById('photosGrid');
            const capturedImages = JSON.parse(localStorage.getItem('capturedImages')) || [];

            if (capturedImages.length === 0) {
                photosGrid.innerHTML = '<p style="text-align: center; color: #666;">No photos captured yet. Please take photos first.</p>';
                return;
            }

            let selectedPhotos = 0;
            const MAX_PHOTOS = 4;

            // Display captured images
            capturedImages.forEach((imageData, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'photo-container';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'photo-checkbox';
                checkbox.id = `photo-${index}`;
                
                // Add checkbox change event listener
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (selectedPhotos >= MAX_PHOTOS) {
                            e.target.checked = false;
                            alert('You can only select 4 photos for the photo strip!');
                            return;
                        }
                        selectedPhotos++;
                    } else {
                        selectedPhotos--;
                    }
                });
                
                const img = document.createElement('img');
                img.src = imageData;
                img.setAttribute('crossorigin', 'anonymous');
                
                imgContainer.appendChild(checkbox);
                imgContainer.appendChild(img);
                photosGrid.appendChild(imgContainer);
            });

            // Set default selected strip
            let selectedStrip = 'Red';
            let selectedEffect = 'normal';
            document.querySelector('.strip-preview[data-color="red"]').classList.add('active');

            // Strip selection
            document.querySelectorAll('.strip-preview').forEach(strip => {
                strip.addEventListener('click', () => {
                    document.querySelectorAll('.strip-preview').forEach(s => 
                        s.classList.remove('active'));
                    strip.classList.add('active');
                    selectedStrip = strip.getAttribute('data-color');
                });
            });

            // Effect selection
            document.querySelectorAll('.effect-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.effect-btn').forEach(b => 
                        b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedEffect = btn.textContent.toLowerCase();
                    applyEffect();
                });
            });

            function applyEffect() {
                const images = document.querySelectorAll('.photo-container img');
                images.forEach(img => {
                    switch(selectedEffect) {
                        case 'black & white':
                            img.style.filter = 'grayscale(100%)';
                            break;
                        case 'sepia':
                            img.style.filter = 'sepia(100%)';
                            break;
                        case 'vintage':
                            img.style.filter = 'sepia(50%) contrast(95%) brightness(95%)';
                            break;
                        case 'high contrast':
                            img.style.filter = 'contrast(150%) brightness(110%)';
                            break;
                        default:
                            img.style.filter = 'none';
                    }
                });
            }

            // Add Select All functionality
            const selectAllBtn = document.getElementById('selectAllBtn');
            selectAllBtn.addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.photo-checkbox');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => cb.checked = !allChecked);
            });

            // Add download buttons functionality
            const downloadPhotos = document.getElementById('downloadPhotos');
            const downloadStrip = document.getElementById('downloadStrip');

            downloadPhotos.addEventListener('click', () => {
                const selectedImages = Array.from(document.querySelectorAll('.photo-checkbox:checked'))
                    .map(checkbox => checkbox.parentElement.querySelector('img').src);
                
                selectedImages.forEach((imgData, index) => {
                    const link = document.createElement('a');
                    link.download = `photo-${index + 1}.jpg`;
                    link.href = imgData;
                    link.click();
                });
            });

            downloadStrip.addEventListener('click', () => {
                const selectedImages = Array.from(document.querySelectorAll('.photo-checkbox:checked'))
                    .map(checkbox => checkbox.parentElement.querySelector('img').src);

                if (selectedImages.length !== 4) {
                    alert('Please select exactly 4 photos for the photo strip!');
                    return;
                }

                // Create photo strip logic here
                createPhotoStrip(selectedImages);
            });

            // Update createPhotoStrip function
            async function createPhotoStrip(images) {
                // Check if template exists
                const templateExists = await checkImageExists(`Photo/${selectedStrip}.png`);
                if (!templateExists) {
                    alert(`Error: Could not load template ${selectedStrip}. Please check file path.`);
                    return;
                }

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set photostrip dimensions
                canvas.width = 600;
                canvas.height = 1800;
                
                try {
                    // Load strip template
                    const stripImg = new Image();
                    stripImg.crossOrigin = 'anonymous';
                    await new Promise((resolve, reject) => {
                        stripImg.onload = resolve;
                        stripImg.onerror = reject;
                        stripImg.src = `Photo/${selectedStrip}.png`; // Changed from strips/ to Photo/
                    });
                    
                    // Draw strip template
                    ctx.drawImage(stripImg, 0, 0, canvas.width, canvas.height);
                    
                    // Draw selected images
                    for (let i = 0; i < images.length; i++) {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = reject;
                            img.src = images[i];
                        });
                        
                        // Calculate position for each photo
                        const y = 150 + (i * 425); // Adjust spacing as needed
                        ctx.drawImage(img, 50, y, 500, 375);
                    }
                    
                    // Download the final strip
                    const link = document.createElement('a');
                    link.download = `photostrip-${selectedStrip.toLowerCase()}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.8);
                    link.click();
                    
                } catch (error) {
                    console.error('Error creating photo strip:', error);
                    alert('Error creating photo strip. Please try again.');
                }
            }

            // Add helper function for applying effects
            function applyEffectToImageData(imageData, effect) {
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    switch(effect) {
                        case 'black & white':
                            const avg = (r + g + b) / 3;
                            data[i] = data[i + 1] = data[i + 2] = avg;
                            break;
                        case 'sepia':
                            data[i] = (r * 0.393) + (g * 0.769) + (b * 0.189);
                            data[i + 1] = (r * 0.349) + (g * 0.686) + (b * 0.168);
                            data[i + 2] = (r * 0.272) + (g * 0.534) + (b * 0.131);
                            break;
                        case 'vintage':
                            data[i] = r * 1.1;
                            data[i + 1] = g * 0.9;
                            data[i + 2] = b * 0.9;
                            break;
                        case 'high contrast':
                            data[i] = r * 1.5;
                            data[i + 1] = g * 1.5;
                            data[i + 2] = b * 1.5;
                            break;
                    }
                }
            }
        });
    </script>
</body>
</html>